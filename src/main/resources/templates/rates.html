<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KRW 기준 환율</title>

    <!-- lightweight-charts -->
    <script src="https://unpkg.com/lightweight-charts@4.3.0/dist/lightweight-charts.standalone.production.js" defer></script>

    <style>
        :root {
          --bg: #0B1221;
          --panel: #0F172A;
          --text: #D1D5DB;
          --muted: #9CA3AF;
          --up: #10B981;
          --down: #EF4444;
          --grid: rgba(255,255,255,0.06);
          --accent: #2563EB;
        }
        html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
        .wrap { display: grid; grid-template-columns: 320px 1fr; gap: 16px; height: 100%; box-sizing: border-box; padding: 16px; }
        .panel { background: var(--panel); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.2); }
        .panel h2 { margin: 0 0 8px; font-size: 18px; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        label { font-size: 12px; color: var(--muted); }
        select, input[type="number"] {
          background: #0b1221; color: var(--text); border: 1px solid #1F2937; border-radius: 10px; padding: 8px 10px; outline: none;
        }
        button.tf { background: #111827; color: var(--text); border: 1px solid #1F2937; border-radius: 999px; padding: 8px 12px; cursor: pointer; }
        button.tf.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(37,99,235,.25) inset; }
        .chart-card { background: var(--panel); border-radius: 16px; padding: 12px; height: 100%; display: flex; flex-direction: column; box-shadow: 0 6px 24px rgba(0,0,0,.2); }
        #chart-area { flex: 1; min-height: 520px; border-radius: 12px; }
        #status { font-size: 12px; color: var(--muted); margin-top: 6px; min-height: 16px; }
        .pair-title { font-size: 16px; font-weight: 600; display: flex; align-items: baseline; gap: 8px; }
        .last-quote { font-size: 14px; color: var(--text); }
        .hint { font-size: 12px; color: var(--muted); }
        .divider { height: 1px; background: #1F2937; margin: 8px 0; }
    </style>
</head>
<body>
<div class="wrap">
    <!-- 좌측 컨트롤 패널: KRW 기준 5통화만 -->
    <aside class="panel">
        <div>
            <h2>설정</h2>

            <div class="row" style="margin-top:8px;">
                <div style="display:flex; flex-direction:column; gap:6px; min-width:100%;">
                    <label for="pair">통화 (KRW 기준)</label>
                    <!-- 화면엔 KRW/XXX로 보이지만, 내부적으로는 API 쿼리를 위해 XXX/KRW로 매핑 후 역수 처리 -->
                    <select id="pair">
                        <option value="KRW/USD" selected>KRW/USD (달러)</option>
                        <option value="KRW/JPY">KRW/JPY (엔)</option>
                        <option value="KRW/CNY">KRW/CNY (위안)</option>
                        <option value="KRW/GBP">KRW/GBP (파운드)</option>
                        <option value="KRW/EUR">KRW/EUR (유로)</option>
                    </select>
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <div style="display:flex; flex-direction:column; gap:6px; min-width:100%;">
                    <label>타임프레임</label>
                    <div id="tf-buttons" class="row">
                        <button class="tf active" data-tf="1h">1h</button>
                        <button class="tf" data-tf="30m">30m</button>
                        <button class="tf" data-tf="15m">15m</button>
                        <button class="tf" data-tf="4h">4h</button>
                        <button class="tf" data-tf="1day">1d</button>
                        <button class="tf" data-tf="1week">1w</button>
                        <button class="tf" data-tf="1month">1M</button>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <div style="display:flex; flex-direction:column; gap:6px; min-width:100%;">
                    <label for="limit">캔들 수</label>
                    <input id="limit" type="number" min="50" max="5000" value="240" />
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <label style="display:flex; align-items:center; gap:8px;">
                    <input id="live" type="checkbox" />
                    실시간(간이)
                </label>
            </div>

            <div class="divider"></div>
            <div class="pair-title">
                <span id="pair-label">KRW/USD</span>
                <span class="last-quote" id="last-quote"></span>
            </div>
            <div class="hint">※ 항상 <b>KRW 기준</b>으로 표시합니다. (백엔드는 XXX/KRW를 조회, 프론트에서 역수 처리)</div>

            <div id="status"></div>
        </div>
    </aside>

    <!-- 우측 차트 -->
    <main class="chart-card">
        <div id="chart-area"></div>
    </main>
</div>

<script>
    // ========= 전역 =========
    let chart, candleSeries, resizeObs, liveTimer = null;

    // KRW 기준 표시 <-> 백엔드 심볼 매핑 (조회는 XXX/KRW)
    const DISPLAY_TO_API = {
      'KRW/USD': 'USD/KRW',
      'KRW/JPY': 'JPY/KRW',
      'KRW/CNY': 'CNY/KRW',
      'KRW/GBP': 'GBP/KRW',
      'KRW/EUR': 'EUR/KRW',
    };

    const $ = (id) => document.getElementById(id);

    function ensureReady() {
      if (!chart) {
        const cont = $('chart-area');
        chart = LightweightCharts.createChart(cont, {
          layout: { textColor: '#D1D5DB', background: { type: 'solid', color: '#0B1221' } },
          grid: { vertLines: { color: 'rgba(255,255,255,0.06)' }, horzLines: { color: 'rgba(255,255,255,0.06)' } },
          timeScale: { timeVisible: true, borderVisible: false },
          rightPriceScale: { borderVisible: false },
          crosshair: { mode: 0 }
        });
      }
      if (!candleSeries) {
        candleSeries = chart.addCandlestickSeries({
          upColor: '#10B981', downColor: '#EF4444',
          borderUpColor: '#10B981', borderDownColor: '#EF4444',
          wickUpColor: '#10B981', wickDownColor: '#EF4444',
          priceFormat: { type: 'price', precision: 6, minMove: 0.000001 }
        });
      }
    }

    function initChart() {
      ensureReady();
      if (!resizeObs) {
        const cont = $('chart-area');
        resizeObs = new ResizeObserver(() => {
          try { chart.timeScale().fitContent(); } catch (_) {}
        });
        resizeObs.observe(cont);
      }
    }

    // 백엔드 캔들을 받아 KRW 기준으로 역수 변환
    function invertCandles(candles) {
      // 역수 규칙: O=1/O, H=1/L, L=1/H, C=1/C
      return candles.map(c => ({
        time: c.time,
        open: 1 / c.open,
        high: 1 / c.low,
        low:  1 / c.high,
        close: 1 / c.close,
      }));
    }

    function parseCandles(values) {
      return values.map(it => ({
        time: Math.floor(new Date((it.datetime || it.date || it.time) + 'Z').getTime() / 1000),
        open: Number(it.open),
        high: Number(it.high),
        low:  Number(it.low),
        close:Number(it.close),
      }));
    }

    function precisionFor(v) {
      if (!isFinite(v) || v === 0) return 6;
      const a = Math.abs(v);
      if (a >= 1) return 2;
      if (a >= 0.1) return 3;
      if (a >= 0.01) return 4;
      return 6;
    }

    function fmt(n, p) {
      try {
        return Number(n).toLocaleString(undefined, { minimumFractionDigits: p, maximumFractionDigits: p });
      } catch { return String(n); }
    }

    async function fetchCandles(apiPair, tf, limit) {
      const url = `/api/td-candles?pair=${encodeURIComponent(apiPair)}&tf=${encodeURIComponent(tf)}&limit=${limit}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const body = await res.json();
      return Array.isArray(body?.values) ? body.values : [];
    }

    async function loadChart(displayPair, tf, limit) {
      ensureReady();
      const statusEl = $('status');
      const lastEl = $('last-quote');
      const labelEl = $('pair-label');

      labelEl.textContent = displayPair;
      statusEl.textContent = '불러오는 중…';
      lastEl.textContent = '';

      const apiPair = DISPLAY_TO_API[displayPair];
      if (!apiPair) {
        statusEl.textContent = '지원하지 않는 통화';
        throw new Error('Unsupported display pair');
      }

      const raw = await fetchCandles(apiPair, tf, limit);
      if (raw.length === 0) {
        statusEl.textContent = '데이터 없음';
        throw new Error('No candles');
      }

      // 백엔드(XXX/KRW) → 정방향 캔들 → KRW 기준으로 역수 변환
      const baseCandles = parseCandles(raw);
      const krwBaseCandles = invertCandles(baseCandles);

      // 자릿수 동적 적용
      const last = krwBaseCandles[krwBaseCandles.length - 1].close;
      const prec = precisionFor(last);
      candleSeries.applyOptions({ priceFormat: { type: 'price', precision: prec, minMove: Number((1).toFixed(prec)) / (10 ** prec) || 0.000001 } });

      candleSeries.setData(krwBaseCandles);
      chart.timeScale().fitContent();

      lastEl.textContent = `1 KRW ≈ ${fmt(last, prec)} ${displayPair.split('/')[1]}`;
      statusEl.textContent = `완료: ${displayPair} • ${tf} • ${krwBaseCandles.length}개`;
    }

    function reloadChart(displayPair, tf, limit) {
      if (chart) { try { chart.remove(); } catch(_) {} }
      chart = null; candleSeries = null;
      initChart();
      return loadChart(displayPair, tf, limit);
    }

    function startLive(displayPair, tf) {
      if (liveTimer) clearInterval(liveTimer);
      liveTimer = setInterval(async () => {
        try {
          ensureReady();
          const apiPair = DISPLAY_TO_API[displayPair];
          const res = await fetch(`/api/td-candles?pair=${encodeURIComponent(apiPair)}&tf=${encodeURIComponent(tf)}&limit=1`);
          if (!res.ok) return;
          const json = await res.json();
          const v = Array.isArray(json?.values) ? json.values[0] : null;
          if (!v) return;
          // 역수 변환 적용
          const c = {
            time: Math.floor(new Date((v.datetime || v.date || v.time) + 'Z').getTime() / 1000),
            open: 1 / Number(v.open),
            high: 1 / Number(v.low),
            low:  1 / Number(v.high),
            close:1 / Number(v.close),
          };
          candleSeries.update(c);

          const prec = precisionFor(c.close);
          $('last-quote').textContent = `1 KRW ≈ ${fmt(c.close, prec)} ${displayPair.split('/')[1]}`;
        } catch(_) {}
      }, 3000);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const pairEl = $('pair');
      const tfButtons = $('tf-buttons');
      const limitEl = $('limit');
      const liveChk = $('live');

      const State = {
        displayPair: pairEl.value, // KRW/XXX
        tf: (tfButtons.querySelector('button.tf.active')?.dataset.tf) || '1h',
        limit: Number(limitEl.value) || 240,
      };

      initChart();
      try { await loadChart(State.displayPair, State.tf, State.limit); } catch (e) { console.error(e); }
      if (liveChk.checked) startLive(State.displayPair, State.tf);

      tfButtons.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-tf]');
        if (!btn) return;
        tfButtons.querySelectorAll('button.tf').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        State.tf = btn.dataset.tf;
        try {
          await reloadChart(State.displayPair, State.tf, State.limit);
          if (liveChk.checked) startLive(State.displayPair, State.tf);
        } catch (err) { console.error(err); }
      });

      pairEl.addEventListener('change', async () => {
        State.displayPair = pairEl.value;
        try {
          await reloadChart(State.displayPair, State.tf, State.limit);
          if (liveChk.checked) startLive(State.displayPair, State.tf);
        } catch (err) { console.error(err); }
      });

      limitEl.addEventListener('change', async () => {
        State.limit = Number(limitEl.value) || 240;
        try {
          await reloadChart(State.displayPair, State.tf, State.limit);
          if (liveChk.checked) startLive(State.displayPair, State.tf);
        } catch (err) { console.error(err); }
      });

      liveChk.addEventListener('change', () => {
        if (liveChk.checked) startLive(State.displayPair, State.tf);
        else if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
      });
    });
</script>
</body>
</html>
